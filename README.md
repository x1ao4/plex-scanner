# plex-scanner
由于 Plex 原生不支持挂载目录的自动扫描和局部扫描，我们在媒体库管理来自挂载目录的媒体文件时不是很方便，新增的文件并不会自动入库，我们常常需要通过手动扫描/刷新或者定期扫描才能让来自挂载目录的新增文件入库，这对网盘用户来说是非常不方便的。

虽然已经存在一些手段可以间接、变相的实现类似于自动扫描、局部扫描的功能，比如 CloudDrive 的文件变更通知，或者其他的定期遍历挂载目录、通过定期对比或扫描的方式也可以实现类似的功能。但可能也会存在一定的局限性，所以我还是自己写了一个脚本，可以用更快捷、更便利、更灵活的方式，通过手动输入文件夹名称来快速实现手动局部扫描。

解释一下，局部扫描是指仅扫描某一个具体的文件夹。当你在资料库点击「扫描资料库文件」时，Plex 会扫描该库添加的所有目录下的所有文件夹内的文件；当你点击某个影片或剧集的「刷新元数据」（并勾选了「自动扫描我的媒体库」和「当检测到更改时，启动局部扫描」）时，Plex 会扫描对应项目所指向的所有目录下的所有文件夹内的文件。

当你的网盘更新了电影文件时，你在 Plex 内能实现的最小范围的扫描是扫描影片所在库的所有目录；当你的网盘剧集有更新时，你在 Plex 内能实现的最小范围的扫描是扫描该剧对应的所有目录。

而通过 plex-scanner，可以将扫描范围缩小到只扫描新增文件所在的文件夹，也就是可以实现只扫描新增电影的这一个文件夹，或者只扫描新增剧集所在的季的这一个文件夹，这是 Plex 能做到的最小范围的扫描任务。而你需要做的就只是输入这个文件夹的名称而已。

## 示例
运行 plex-scanner 后按照提示输入要扫描的文件夹名称即可，若需要扫描多个文件夹，可以分次输入，或使用 `；` 隔开多个文件夹名称，支持多级目录。
```
请输入要扫描的文件夹名称，多个文件夹名称用分号隔开：彗星来的那一夜 (2013)

成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/电影/彗星来的那一夜 (2013)

请输入要扫描的文件夹名称，多个文件夹名称用分号隔开：兰戈 (2011)；洛基 (2021)/洛基 - S02；花儿与少年 (2014)

成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/电影/兰戈 (2011)
成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/电视剧/洛基 (2021)/洛基 - S02
成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/综艺/花儿与少年 (2014)

请输入要扫描的文件夹名称，多个文件夹名称用分号隔开：周六夜现场 (1975)/周六夜现场 - S49；爱乐之城 (2016)

成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/综艺/周六夜现场 (1975)/周六夜现场 - S49
成功触发Plex扫描文件夹：/Users/x1ao4/Media/阿里资源主/影视/电影/爱乐之城 (2016)
```

## 运行条件
- 安装了 Python 3.0 或更高版本。
- 安装了必要的第三方库：requests。（可以通过 `pip install requests` 安装）

## 配置文件
在运行脚本前，请先打开配置文件 `config.ini`，按照以下提示进行配置，下方为配置示例和说明，请按照自己的需求进行配置。
```
[server]
# Plex 服务器的地址，格式为 http://服务器IP地址:32400 或 http(s)://域名:端口号
address = http://127.0.0.1:32400
# Plex 服务器的 token，用于身份验证
token = xxxxxxxxxxxxxxxxxxxx

[mode]
# 连续扫描模式的开关，如果设置为 True，可以连续多次请求扫描，如果设置为 False，则会在处理请求后结束运行
continuous_mode = True

[directories]
# 指定需要进行扫描的文件夹的上级目录，格式为 库名 = 目录1；目录2；目录3
电影 = /Users/x1ao4/Media/阿里资源主/影视/电影
电视剧 = /Users/x1ao4/Media/阿里资源主/影视/电视剧；/Users/x1ao4/Media/迅雷云盘/电视剧
综艺 = /Users/x1ao4/Media/阿里资源主/影视/综艺

[libraries]
# 指定需要进行扫描的文件夹所在的库，格式为 库名1；库名2；库名3，如果没有设置此项且 [directories] 为空，则会默认需要进行扫描的文件夹可能存在于任何库中
libraries = 电影；电视剧；综艺

[exclude_directories]
# 指定需要排除的上级目录，格式为 库名 = 目录1；目录2；目录3，如果设置了此项，则会在扫描时忽略这些目录下的文件夹
电影 = /Users/x1ao4/Media/夸克主盘/电影；/Users/x1ao4/Media/天翼云盘/电影
综艺 = /Users/x1ao4/Media/阿里资源副/影视/综艺
```
配置文件中只有 `[server]` 和 `[mode]` 是必填项目，其他项目请按需设置，可以留空。

## 工作原理
plex-scanner 的工作原理是通过配置文件中的 `[directories]`、`[libraries]` 和 `[exclude_directories]` 筛选出目录前缀，然后加上用户提供的 `文件夹名称` 构建出需要进行扫描的文件夹的可能路径，然后通过检查这些路径是否真实存在，筛选出真正需要扫描的文件夹路径并进行扫描。

例如当配置如下时：
```
[directories]
电影 = /Users/x1ao4/Media/阿里资源主/影视/电影
电视剧 = /Users/x1ao4/Media/阿里资源主/影视/电视剧；/Users/x1ao4/Media/迅雷云盘/电视剧
综艺 = /Users/x1ao4/Media/阿里资源主/影视/综艺

[libraries]
libraries = 

[exclude_directories]

```
运行脚本会提示用户输入文件夹名称，假如用户输入的文件夹名称为 `乱世佳人 (1939)`，脚本会在后台构建出如下目录：
```
/Users/x1ao4/Media/阿里资源主/影视/电影/乱世佳人 (1939)
/Users/x1ao4/Media/阿里资源主/影视/电视剧/乱世佳人 (1939)
/Users/x1ao4/Media/迅雷云盘/电视剧/乱世佳人 (1939)
/Users/x1ao4/Media/阿里资源主/影视/综艺/乱世佳人 (1939)
```
然后排除不存在的目录，筛选出真实存在的文件夹路径 `/Users/x1ao4/Media/阿里资源主/影视/电影/乱世佳人 (1939)` 进行扫描。

plex-scanner 提供了两种设置目录前缀的方式：`[directories]` 和 `[libraries]`。其实这两个选项就是用来设置更新文件可能存在的目录范围的。

- `[directories]`：假如你需要通过手动局部扫描入库的文件都集中在某几个目录内，可以使用 `[directories]` 来指定这些目录，把 `[libraries]` 和 `[exclude_directories]` 留空。
- `[libraries]`：假如你需要通过手动局部扫描入库的文件比较分散，他们所属的目录比较多，可以使用 `[libraries]` 来指定库，脚本会自动获取这些库的所有目录（若 `[libraries]` 为空则会获取所有库的所有目录），然后你可以使用 `[exclude_directories]` 排除掉不需要手动扫描的目录，把 `[directories]` 留空。

简单说就是需要手动扫描的目录较少可以选择配置 `[directories]`，较多可以选择配置 `[libraries]` 和 `[exclude_directories]`，若这三个选项全部留空（默认设置），表示会使用服务器上的所有库的所有目录作为目录前缀，然后与用户提供的文件夹名称分别进行配对，找出需要被扫描的文件夹进行扫描。

配置时需要填写的目录也就是你在媒体库添加文件夹时使用的目录，例如：

<img width="100%" alt="dir1" src="https://github.com/x1ao4/plex-scanner/assets/112841659/337e46a1-2350-4c31-abb1-a6addd560cb8">

## 使用方法
1. 将仓库克隆或下载到计算机上的一个目录中。
2. 修改 `start.command (Mac)` 或 `start.bat (Win)` 中的路径，以指向您存放 `plex-scanner.py` 脚本的目录。
3. 打开 `config.ini`，填写您的 Plex 服务器地址（`address`）和 [X-Plex-Token](https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/)（`token`），按照需要选填其他配置选项。
4. 双击运行 `start.command` 或 `start.bat` 脚本以执行 `plex-scanner.py` 脚本。
5. 按照提示输入 `文件夹名称`，按回车。
6. 脚本会根据配置文件触发 Plex 扫描对应的文件夹，并在控制台显示扫描结果（您也可以在服务器的「设置 - 状态 - 警告」中查看扫描记录）。

## 注意事项
- 请确保您提供了正确的 Plex 服务器地址和 [X-Plex-Token](https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/)。
- 请确保您提供了正确的库名、目录与文件夹名。
- 请确保运行脚本的设备可以连接到您的服务器。
- 脚本在某些情况下会触发媒体库刷新其他项目的元数据，但并不会触发非指定文件夹的扫描动作。

